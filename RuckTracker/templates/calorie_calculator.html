<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics Tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PYLNW662H0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-PYLNW662H0');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rucking Calorie Calculator | Compare Methods (Mechanical, MET, HR)</title>
  <meta name="description" content="Rucking calorie calculator. Enter your stats to compare calories by three methods: Mechanical (Pandolf), MET-based, and Heart Rate-based. Dial in accurate calorie estimates for your rucks." />
  <link rel="canonical" href="https://getrucky.com/rucking-calorie-calculator" />
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-green: #728C69;
      --bg-offwhite: #FAF9F7;
      --text: #111;
      --content-max: 1200px;
    }
    body { background: var(--bg-offwhite) !important; color: var(--text) !important; }
    .site-header { max-width: var(--content-max); margin: 24px auto 8px; padding: 0 16px; display: flex; align-items: center; gap: 16px; min-height: 56px; }
    .brand { color: var(--brand-green); font-family: 'Bebas Neue', Impact, Arial Black, sans-serif; font-weight: 400; font-size: 1.5rem; letter-spacing: 1px; text-decoration: none; white-space: nowrap; }
    .tagline { color: #5A5A5A; font-size: 0.95rem; line-height: 1.4; }
    
    /* Content container - same as blog page */
    .content-container { padding-inline: 16px; max-width: var(--content-max); margin: 0 auto 80px; background: transparent !important; box-shadow: none !important; border: none !important; border-radius: 0 !important; }
  </style>
  <meta property="og:title" content="Rucking Calorie Calculator" />
  <meta property="og:description" content="Compare rucking calories with Mechanical (Pandolf), MET-based, and HR-based methods." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://getrucky.com/rucking-calorie-calculator" />
  <meta name="twitter:card" content="summary_large_image" />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Rucking Calorie Calculator",
    "url": "https://getrucky.com/rucking-calorie-calculator",
    "description": "Rucking calorie calculator. Enter your stats to compare calories by three methods: Mechanical (Pandolf), MET-based, and Heart Rate-based.",
    "isPartOf": {"@type":"WebSite","name":"Get Rucky","url":"https://getrucky.com"}
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Rucking Calorie Calculator",
    "applicationCategory": "FitnessApplication",
    "operatingSystem": "Any",
    "url": "https://getrucky.com/rucking-calorie-calculator",
    "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"}
  }
  </script>
  <style>
    /* Modern form styling */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; margin: 2rem 0; }
    .form-section { max-width: 800px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; align-items: start; }
    .form-row.single { grid-template-columns: 1fr; }
    .form-row > div { min-width: 0; }
    
    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 0.5rem; 
      color: #333; 
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input, select { 
      width: 100%; 
      padding: 0.75rem; 
      border: 2px solid #e0e0e0; 
      border-radius: 8px; 
      font-size: 1rem; 
      transition: border-color 0.2s ease;
      background: white;
      box-sizing: border-box;
      min-height: 48px;
    }
    
    input:focus, select:focus { 
      outline: none; 
      border-color: var(--brand-green); 
      box-shadow: 0 0 0 3px rgba(114, 140, 105, 0.1);
    }
    
    /* Modern button styling */
    .calc-button {
      background: var(--brand-green);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2rem 0;
    }
    
    .calc-button:hover {
      background: #5d7354;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(114, 140, 105, 0.3);
    }
    
    /* Units toggle styling */
    .units-toggle {
      display: flex;
      gap: 0;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .units-toggle button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: white;
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    
    .units-toggle button[aria-pressed="true"] {
      background: var(--brand-green);
      color: white;
    }
    
    /* Modern table styling */
    .results-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 2rem 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .results-table th {
      background: linear-gradient(135deg, var(--brand-green), #5d7354);
      color: white;
      padding: 1.25rem 1.5rem;
      text-align: left;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .results-table td {
      padding: 1.25rem 1.5rem;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    
    .results-table tr:last-child td {
      border-bottom: none;
    }
    
    .results-table .method-name {
      font-weight: 700;
      color: #333;
      font-size: 1rem;
    }
    
    .results-table .calories-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--brand-green);
    }
    
    .results-table .method-description {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; gap: 1rem; }
      .form-row { grid-template-columns: 1fr; gap: 1rem; }
      .form-row.single { grid-template-columns: 1fr; }
      .form-section { max-width: 100%; }
      
      /* Stack intro section on mobile */
      section[style*="grid-template-columns: 1fr 300px"] {
        grid-template-columns: 1fr !important;
        gap: 2rem !important;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a class="brand" href="/">RUCK</a>
    <div class="tagline">Calculate and compare rucking calories using two different methods.</div>
  </header>
  <main class="content-container">
    
    <!-- Introduction -->
    <section style="margin-bottom: 3rem; display: grid; grid-template-columns: 1fr 300px; gap: 3rem; align-items: start;">
      <div>
        <h1 style="margin: 0 0 1rem 0; font-size: 2.5rem; color: var(--brand-green); text-shadow: none !important;">Rucking Calorie Calculator</h1>
        <p style="font-size: 1.1rem; line-height: 1.6; color: #555;">
          Rucking burns calories differently than regular walking or running. The added weight, varied terrain, and load distribution create unique metabolic demands that standard fitness trackers often underestimate. Our calculator uses two scientifically-backed methods specifically designed for load carriage activities to give you accurate calorie estimates.
        </p>
      </div>
      <div style="text-align: right;">
        <img src="{{ url_for('static', filename='images/blog/caloriepage.jpg') }}" 
             alt="Rucking calorie calculation visualization" 
             style="width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
      </div>
    </section>

    <!-- Input Form -->
    <section class="form-grid">
      <div class="form-section">
        <h2 style="margin: 0 0 1.5rem 0; color: var(--brand-green); font-size: 1.5rem;">Input Your Data</h2>
        
        <div class="form-row single">
          <div>
            <label>Units</label>
            <div class="units-toggle">
              <button id="unitsMetric" type="button" aria-pressed="false">Metric</button>
              <button id="unitsImperial" type="button" aria-pressed="true">Imperial</button>
            </div>
            <input id="unitSystem" type="hidden" value="imperial" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="weightKg">Body weight (<span id="unitWeight">lb</span>)</label>
            <input id="weightKg" type="number" min="20" max="250" step="0.1" value="175" />
          </div>
          <div>
            <label for="ruckKg">Ruck weight (<span id="unitRuck">lb</span>)</label>
            <input id="ruckKg" type="number" min="0" max="60" step="0.1" value="20" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="distanceKm">Distance (<span id="unitDistance">mi</span>)</label>
            <input id="distanceKm" type="number" min="0" max="100" step="0.01" value="3" />
          </div>
          <div>
            <label for="duration">Duration (hh:mm)</label>
            <input id="duration" type="text" value="01:00" placeholder="hh:mm" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="elevGain">Elevation gain (<span id="unitElev">m</span>)</label>
            <input id="elevGain" type="number" min="0" max="5000" step="1" value="50" />
          </div>
          <div>
            <label for="elevLoss">Elevation loss (<span id="unitElev2">m</span>)</label>
            <input id="elevLoss" type="number" min="0" max="5000" step="1" value="0" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="unspecified" selected>Unspecified</option>
            </select>
          </div>
          <div>
            <label for="age">Age (for fusion method)</label>
            <input id="age" type="number" min="10" max="90" step="1" value="30" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="avgHr">Average Heart Rate (bpm)</label>
            <input id="avgHr" type="number" min="60" max="220" step="1" value="140" />
            <p style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">Optional. Used for fusion method accuracy.</p>
          </div>
          <div>
            <label for="terrain">Terrain</label>
            <select id="terrain">
              <option value="1.00">Pavement (1.00)</option>
              <option value="1.05">Gravel / packed dirt (1.05)</option>
              <option value="1.10">Trail / grass (1.10)</option>
              <option value="1.20">Sand / snow (1.20)</option>
            </select>
          </div>
        </div>
        
        <button id="calcBtn" class="calc-button">Calculate Calories</button>
      </div>
    </section>

    <!-- Results -->
    <section style="margin: 3rem 0;">
      <h2 style="margin: 0 0 1.5rem 0; color: var(--brand-green); font-size: 1.5rem;">Calorie Comparison</h2>
      
      <table class="results-table">
        <thead>
          <tr>
            <th>Method</th>
            <th>Calories Burned</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="method-name">Mechanical (Enhanced Pandolf)</td>
            <td class="calories-value" id="mechOut">—</td>
            <td class="method-description">GORUCK-enhanced equation with research-based load-ratio corrections for heavy loads.</td>
          </tr>
          <tr>
            <td class="method-name">Fusion (App Only)</td>
            <td class="calories-value" id="fusionOut">—</td>
            <td class="method-description">Blends mechanical + heart rate + weather + terrain for maximum accuracy.</td>
          </tr>
        </tbody>
      </table>
      
      <p id="fusionNote" style="display:none; color: var(--brand-green); font-weight: 600; margin-top: 1rem;">
        💡 The app's Fusion method provides the most accurate estimates by combining multiple data sources.
      </p>
    </section>

    <!-- Scientific Method Descriptions -->
    <section style="margin-top: 3rem;">
      <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--brand-green);">Scientific Methodology</h2>
      
      <div style="display: grid; gap: 2rem;">
        <!-- Mechanical Method -->
        <div class="card">
          <h3 style="margin-top: 0; color: var(--brand-green); font-size: 1.25rem;">Mechanical (Enhanced Pandolf Equation)</h3>
          <p style="margin-bottom: 1rem; font-weight: 600; color: #333;">The gold standard for load carriage energy expenditure, enhanced with recent military research.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Scientific Foundation:</h4>
          <p>Based on the Pandolf equation (1977), originally developed by the U.S. Army Research Institute of Environmental Medicine for predicting energy expenditure during load carriage activities. This is the same enhanced formula used by GORUCK's calorie calculator.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">What We Account For:</h4>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.6;">
            <li><strong>Body Weight:</strong> Base metabolic cost of movement</li>
            <li><strong>Load Weight:</strong> Additional energy required to carry external weight</li>
            <li><strong>Speed:</strong> Exponential relationship between pace and energy cost</li>
            <li><strong>Grade/Elevation:</strong> Uphill increases cost, downhill decreases it</li>
            <li><strong>Terrain Surface:</strong> Energy multipliers for different surfaces (pavement 1.0x, sand/snow 1.2x)</li>
            <li><strong>Load-to-Body-Weight Ratio:</strong> Enhanced correction factor addressing Pandolf's known underestimation</li>
          </ul>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Research Enhancements:</h4>
          <p>Australian military studies (2017) found the original Pandolf equation underestimates calories by 12-17% at moderate speeds and 21-33% at faster speeds with heavy loads. Our enhanced version includes dynamic adjustment factors that scale with load-to-body-weight ratio and speed, providing up to 27% correction for scenarios with 33% body weight at 4+ mph.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Best For:</h4>
          <p>Accurate baseline estimates when heart rate data isn't available. Particularly reliable for standard rucking scenarios with moderate to heavy loads.</p>
        </div>

        <!-- Fusion Method -->
        <div class="card">
          <h3 style="margin-top: 0; color: var(--brand-green); font-size: 1.25rem;">Fusion (Recommended - App Only)</h3>
          <p style="margin-bottom: 1rem; font-weight: 600; color: #333;">Our most sophisticated method, combining multiple data sources for maximum accuracy.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Scientific Foundation:</h4>
          <p>Intelligent blend of the Enhanced Pandolf equation with real-time physiological data and environmental factors. Uses confidence-weighted averaging based on data quality and availability.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">What We Account For:</h4>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.6;">
            <li><strong>All Mechanical Factors:</strong> Body weight, load weight, speed, grade, terrain surface</li>
            <li><strong>Real-Time Heart Rate:</strong> Continuous BPM data from Apple Watch/phone sensors</li>
            <li><strong>Personal Physiology:</strong> Age, gender, resting HR, max HR for individualized calculations</li>
            <li><strong>Weather Conditions:</strong>
              <ul style="margin: 0.25rem 0; padding-left: 1rem;">
                <li>Temperature effects (hot weather +15%, cold weather +6-12%)</li>
                <li>Wind resistance (speed-dependent, up to +8% in strong winds)</li>
                <li>Humidity impact (+5% in high humidity conditions)</li>
                <li>Precipitation penalty (+8% for rain/snow)</li>
              </ul>
            </li>
            <li><strong>Terrain Analysis:</strong> GPS-based surface detection with energy multipliers</li>
            <li><strong>Elevation Profile:</strong> Precise GPS altitude changes for grade calculations</li>
            <li><strong>Data Quality Weighting:</strong> Higher confidence in HR data when coverage is good, falls back to mechanical when sparse</li>
          </ul>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Adaptive Algorithm:</h4>
          <p>The fusion method dynamically weights heart rate vs. mechanical calculations based on data quality. With good HR coverage (>80%), it weights HR data at 70-100%. With poor coverage (<40%), it relies more heavily on the proven mechanical model. This ensures accuracy regardless of sensor reliability.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Environmental Intelligence:</h4>
          <p>Integrates real-time weather data to adjust for thermoregulation costs, wind resistance, and precipitation effects. These adjustments are based on exercise physiology research showing 5-15% calorie increases in challenging conditions.</p>
          
          <h4 style="color: #555; margin: 1rem 0 0.5rem 0;">Best For:</h4>
          <p>Maximum accuracy in real-world conditions. Ideal for users with heart rate monitoring who want the most precise calorie estimates that account for all environmental and physiological factors.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer-pinned">
    <div class="footer-links">
      <a href="/">Home</a> |
      <a href="/blog">Blog</a> | <a href="/rucking-calorie-calculator">Rucking Calorie Calculator</a> |
      <a href="/privacy">Privacy Policy</a> |
      <a href="/terms">Terms of Service</a> |
      <a href="/support">Support</a>
    </div>
    <div class="copyright">
      &copy; 2025 Get Rucky, Inc. All rights reserved.
    </div>
  </footer>

  <script>
    function parseDuration(hhmm) {
      const m = /^\s*(\d{1,2}):(\d{2})\s*$/.exec(hhmm || '');
      if (!m) return 0;
      const h = parseInt(m[1], 10); const min = parseInt(m[2], 10);
      if (min >= 60) return 0;
      return h * 3600 + min * 60;
    }
    function kmhToMph(kmh){ return kmh * 0.621371; }
    function clamp(x, a, b){ return Math.min(Math.max(x, a), b); }

    // Unit handling
    const KG_PER_LB = 0.45359237;
    const LB_PER_KG = 1 / KG_PER_LB;
    const KM_PER_MI = 1.609344;
    const MI_PER_KM = 1 / KM_PER_MI;
    const M_PER_FT = 0.3048;
    const FT_PER_M = 1 / M_PER_FT;

    function getUnitSystem(){
      const sel = document.getElementById('unitSystem');
      return sel ? sel.value : 'metric';
    }

    function updateUnitLabels(unit){
      const isImp = unit === 'imperial';
      const weightLabel = document.getElementById('unitWeight');
      const ruckLabel = document.getElementById('unitRuck');
      const distLabel = document.getElementById('unitDistance');
      const elevLabel = document.getElementById('unitElev');
      const elevLabel2 = document.getElementById('unitElev2');
      if (weightLabel) weightLabel.textContent = isImp ? 'lb' : 'kg';
      if (ruckLabel) ruckLabel.textContent = isImp ? 'lb' : 'kg';
      if (distLabel) distLabel.textContent = isImp ? 'mi' : 'km';
      if (elevLabel) elevLabel.textContent = isImp ? 'ft' : 'm';
      if (elevLabel2) elevLabel2.textContent = isImp ? 'ft' : 'm';
    }

    function convertNumber(v, factor){
      const n = parseFloat(v);
      if (isNaN(n)) return '';
      const out = n * factor;
      // keep reasonable precision for UI
      return Math.round(out * 1000) / 1000;
    }

    function convertInputs(fromUnit, toUnit){
      if (fromUnit === toUnit) return;
      const toImp = (toUnit === 'imperial');
      const weightEl = document.getElementById('weightKg');
      const ruckEl = document.getElementById('ruckKg');
      const distEl = document.getElementById('distanceKm');
      const gainEl = document.getElementById('elevGain');
      const lossEl = document.getElementById('elevLoss');

      if (weightEl) weightEl.value = convertNumber(weightEl.value, toImp ? LB_PER_KG : KG_PER_LB);
      if (ruckEl) ruckEl.value = convertNumber(ruckEl.value, toImp ? LB_PER_KG : KG_PER_LB);
      if (distEl) distEl.value = convertNumber(distEl.value, toImp ? MI_PER_KM : KM_PER_MI);
      if (gainEl) gainEl.value = convertNumber(gainEl.value, toImp ? FT_PER_M : M_PER_FT);
      if (lossEl) lossEl.value = convertNumber(lossEl.value, toImp ? FT_PER_M : M_PER_FT);
    }

    // MET calculator pieces matching lib/core/utils/met_calculator.dart
    function calcRuckingMetByGrade(speedMph, grade, ruckWeightLbs){
      let baseMet;
      if (speedMph < 2.0) baseMet = 2.5;
      else if (speedMph < 2.5) baseMet = 3.0;
      else if (speedMph < 3.0) baseMet = 3.5;
      else if (speedMph < 3.5) baseMet = 4.0;
      else if (speedMph < 4.0) baseMet = 4.5;
      else if (speedMph < 5.0) baseMet = 5.0;
      else baseMet = 6.0;

      let gradeAdj = 0.0;
      if (grade > 0) {
        gradeAdj = grade * 0.6 * (speedMph / 4.0);
      } else if (grade < 0) {
        const absG = Math.abs(grade);
        if (absG <= 10) gradeAdj = -absG * 0.1; else gradeAdj = (absG - 10) * 0.15;
      }

      let loadAdj = 0.0;
      if (ruckWeightLbs > 0) loadAdj = Math.min(ruckWeightLbs * 0.05, 5.0);

      const finalMet = clamp(baseMet + gradeAdj + loadAdj, 2.0, 15.0);
      return finalMet;
    }

    function calcCaloriesMet(weightKgTotal, durationMinutes, metValue){
      const hours = durationMinutes / 60.0;
      return Math.max(0, metValue * weightKgTotal * hours);
    }

    // Mechanical (Enhanced Pandolf with GORUCK-style load ratio adjustment)
    function calcMechanicalPandolf({userWeightKg, ruckWeightKg, speedKmh, gradePct, terrainMultiplier, elapsedSeconds}){
      const v = clamp(speedKmh / 3.6, 0.0, 3.0); // m/s
      const W = userWeightKg;
      const L = ruckWeightKg;
      const G = gradePct; // percent
      const eta = clamp(terrainMultiplier, 0.8, 1.3);
      const lw = (W > 0) ? (L / W) : 0.0;
      const termLoad = 2.0 * (W + L) * (lw * lw);
      const termSpeedGrade = eta * (W + L) * (1.5 * v * v + 0.35 * v * clamp(G, -20.0, 30.0));
      let M = 1.5 * W + termLoad + termSpeedGrade; // Watts
      M = clamp(M, 50.0, 800.0);
      
      // GORUCK-inspired load ratio adjustment to address Pandolf underestimation
      // Research shows 12-33% underestimation, scaling with load/body weight ratio and speed
      const loadRatio = lw; // L/W ratio (0.0 to ~0.33 for reasonable loads)
      const speedMph = speedKmh * 0.621371;
      
      // Calculate adjustment factor based on load ratio and speed
      // At 33% body weight + 4mph: ~27% increase (matches research)
      // Scales down for lighter loads and slower speeds
      let adjustmentFactor = 1.0;
      if (loadRatio > 0 && speedMph > 2.0) {
        // Base adjustment scales with load ratio (0-27% at max)
        const baseAdjustment = Math.min(loadRatio * 0.82, 0.27); // Cap at 27%
        // Speed factor: more adjustment at higher speeds (research shows this)
        const speedFactor = Math.min((speedMph - 2.0) / 2.0, 1.0); // 0-1 factor for 2-4mph+
        adjustmentFactor = 1.0 + (baseAdjustment * speedFactor);
      }
      
      // Apply the research-based adjustment
      M = M * adjustmentFactor;
      
      const kcalPerSec = (M / 4186.0);
      let kcal = kcalPerSec * elapsedSeconds;
      if (speedKmh < 0.5 && elapsedSeconds > 0) kcal *= 0.2;
      return Math.max(0, kcal);
    }

    // Heart-rate based (Keytel equations)
    function calcCaloriesHR({avgHr, weightKg, age, gender, durationMinutes}){
      if (!avgHr || avgHr <= 0) return null;
      let calsPerMin;
      if (gender === 'female') {
        calsPerMin = (-20.4022 + (0.4472 * avgHr) - (0.1263 * weightKg) + (0.074 * age)) / 4.184;
      } else {
        calsPerMin = (-55.0969 + (0.6309 * avgHr) + (0.1988 * weightKg) + (0.2017 * age)) / 4.184;
      }
      const total = calsPerMin * durationMinutes;
      return Math.max(0, total);
    }

    function calculate(){
      const unit = getUnitSystem();
      let weightKg = parseFloat(document.getElementById('weightKg').value) || 0;
      let ruckKg = parseFloat(document.getElementById('ruckKg').value) || 0;
      let distanceKm = parseFloat(document.getElementById('distanceKm').value) || 0;
      let elevGain = parseFloat(document.getElementById('elevGain').value) || 0;
      let elevLoss = parseFloat(document.getElementById('elevLoss').value) || 0;
      // Convert UI values back to metric if imperial is selected
      if (unit === 'imperial'){
        weightKg = weightKg * KG_PER_LB;
        ruckKg = ruckKg * KG_PER_LB;
        distanceKm = distanceKm * KM_PER_MI;
        elevGain = elevGain * M_PER_FT;
        elevLoss = elevLoss * M_PER_FT;
      }
      const genderSel = document.getElementById('gender').value;
      const age = parseInt(document.getElementById('age').value, 10) || 30;
      const terrain = parseFloat(document.getElementById('terrain').value) || 1.0;
      const avgHr = parseInt(document.getElementById('avgHr').value, 10);
      const elapsed = parseDuration(document.getElementById('duration').value);
      const durationHours = elapsed / 3600.0;
      const durationMinutes = elapsed / 60.0;
      const speedKmh = (durationHours > 0) ? (distanceKm / durationHours) : 0;

      // grade
      let gradePct = 0.0;
      if (distanceKm > 0) gradePct = ((elevGain - elevLoss) / (distanceKm * 1000)) * 100.0;

      // MET path
      const speedMph = kmhToMph(speedKmh);
      const ruckLbs = ruckKg * 2.20462;
      const metVal = calcRuckingMetByGrade(speedMph, gradePct, ruckLbs);
      let metCalories = calcCaloriesMet(weightKg + ruckKg, durationMinutes, metVal) * terrain;

      // Mechanical path
      const mechCalories = calcMechanicalPandolf({
        userWeightKg: weightKg,
        ruckWeightKg: ruckKg,
        speedKmh: speedKmh,
        gradePct: gradePct,
        terrainMultiplier: terrain,
        elapsedSeconds: elapsed,
      });

      // HR path
      const hrGender = (genderSel === 'female') ? 'female' : 'male';
      const hrCalories = calcCaloriesHR({
        avgHr: avgHr,
        weightKg: weightKg,
        age: age,
        gender: hrGender,
        durationMinutes: durationMinutes,
      });

      // Apply small sex adjustment to MET if gender unspecified (mirroring app fusion behavior)
      if (genderSel === 'unspecified') {
        metCalories *= 0.925;
      }

      // Simulate fusion method (simplified for web calculator)
      let fusionCalories = mechCalories;
      if (hrCalories != null && hrCalories > 0) {
        // Simple blend: 60% mechanical, 40% HR (web simplified version)
        fusionCalories = 0.6 * mechCalories + 0.4 * hrCalories;
      }

      // Render - use different formatting based on units
      const fmt = (x) => {
        if (x == null || isNaN(x)) return 'N/A';
        const rounded = Math.round(x);
        const unit = getUnitSystem();
        if (unit === 'imperial') {
          // Use period separator for imperial (US format)
          return rounded.toLocaleString('en-US');
        } else {
          // Use comma separator for metric (international format)
          return rounded.toLocaleString('en-GB');
        }
      };
      document.getElementById('mechOut').textContent = fmt(mechCalories);
      document.getElementById('fusionOut').textContent = fmt(fusionCalories);
      document.getElementById('fusionNote').style.display = (hrCalories != null) ? 'block' : 'none';
    }

    document.getElementById('calcBtn').addEventListener('click', function(){
      try { calculate(); gtag('event', 'calculate', { 'event_category': 'calorie_calculator' }); } catch(e){}
    });

    // Units setup with toggle buttons
    (function initUnits(){
      const unitHidden = document.getElementById('unitSystem');
      const btnMetric = document.getElementById('unitsMetric');
      const btnImperial = document.getElementById('unitsImperial');
      let last = unitHidden?.value || 'imperial';
      function setActive(next){
        if (!unitHidden) return;
        convertInputs(last, next);
        unitHidden.value = next;
        updateUnitLabels(next);
        last = next;
        const metricActive = next === 'metric';
        if (btnMetric){
          btnMetric.setAttribute('aria-pressed', metricActive ? 'true' : 'false');
        }
        if (btnImperial){
          btnImperial.setAttribute('aria-pressed', metricActive ? 'false' : 'true');
        }
        try { calculate(); gtag('event', 'unit_change', { 'event_category': 'calorie_calculator', 'unit': next }); } catch(e){}
      }
      btnMetric?.addEventListener('click', () => setActive('metric'));
      btnImperial?.addEventListener('click', () => setActive('imperial'));
      updateUnitLabels(last);
      setActive(last);
    })();

    // Initial calc
    updateUnitLabels(getUnitSystem());
    calculate();
  </script>
</body>
</html>
